<!DOCTYPE html><html class="dark"><head><meta charset="utf-8"><title>Polymorphic Type-Directed Function Application</title><meta name="og:title" content="Polymorphic Type-Directed Function Application"><meta property="og:image" content="https://mgsloan.com/images/haskell-placeholder-banner.jpg"><meta property="og:site_name" content="mgsloan"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="treetopian"><link href="/favicon.png" rel="icon" type="image/png"><link href="/feed.xml" rel="alternate" type="application/atom+xml"><link href="https://mgsloan.com/posts/unordered-apply-polymorphic/" rel="canonical"><meta name="description" content="GHC plugin to choose a " best-match" parameter type."><meta name="og:description" content="GHC plugin to choose a " best-match" parameter type."><meta name="author" content="Michael G Sloan"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://fonts.googleapis.com/css?family=Alegreya:700|Alegreya+Sans:400,400i,700|Alegreya+Sans+SC:400|Inconsolata:400,700|Playfair+Display:400,700" rel="stylesheet"><style>*{margin:0;padding:0}code,em,strong{line-height:1}html{font-size:16px;zoom:1.15;background-color:#234}body{background-color:#fffef8;padding-top:0.2em;color:#456;font-family:'Alegreya Sans',sans-serif;font-feature-settings:'liga','kern';line-height:1.6}#content,#teaser,#footer{padding:1.4em;margin-left:auto;margin-right:auto;max-width:36em}#content{padding-top:0;min-height:-moz-available;min-height:-webkit-fill-available;min-height:fill-available}header{font-family:'Playfair Display',sans;margin-left:1em;margin-right:1em;overflow:visible;text-align:center;margin-bottom:1.0em}h1{font-family:'Playfair Display',serif;color:#000;font-size:1.8em;line-height:3.8rem;margin-bottom:0.7rem;padding-top:2.8rem}header>h2{font-feature-settings:'dlig';font-size:1.4em;font-style:italic;font-weight:normal;line-height:1.4rem;margin-bottom:1.0rem;padding-top:0.4rem}header>p{padding-top:0.5em;padding-bottom:0.9em;margin-bottom:0}article>header>hr.hairline{margin-top:0.5em;transform:scale(1.3,0.5)}article hr.hairline{transform:scale(1.09,0.5)}hr.hairline{border:none;border-bottom:1px solid #c35;transform:scale(1,0.5)}.footnotes-divider{margin-top:3.4em;margin-bottom:2.4em}h1>br{display:none}p,nav{margin-bottom:1em;padding-top:0.4em}a{color:#c35;text-decoration:none}a:hover,a:focus{text-decoration:underline;text-decoration-thickness:0.5px;text-underline-offset:3px}abbr,.smcp{font-family:"Alegreya Sans SC";letter-spacing:0.1em;display:inline-block}abbr{letter-spacing:0.03em;margin-right:-0.03em}.run-in{font-family:"Alegreya Sans SC";letter-spacing:0.05em}h2{font-family:Alegreya,serif;font-size:1.4em;line-height:1em;margin-bottom:0.2rem;padding-top:1.2rem}h2>a:before{content:'¶';width:1.2rem;margin-left:-1.2rem;display:inline-block;opacity:0;transition:opacity 0.2s ease-out;color:#b4aaaa}h2:hover>a:before{opacity:1}h2:target>a:before{opacity:1;color:#c35}ul,ol{counter-reset:ol;list-style:none;margin-top:1em}li{position:relative}li:before{display:inline-block;margin-left:-1em;width:1em;position:absolute;top:0}ul>li:before{content:'•';font-weight:bold;transform:scale(1.6);top:-0.15em}ul.affiliate>li:before{content:'$';transform:scale(1)}ol>li:before{content:counter(ol,decimal);counter-increment:ol;font-weight:bold;top:-0.05em}li>p:first-child{display:inline-block;padding-top:0}li>p:first-child + *{margin-top:0}li>ul,li>ol{margin-left:1em}li>ul>li:before{content:"■";transform:scale(0.5);top:-0.05em}table{border-spacing:0;margin-bottom:1em;margin-left:auto;margin-right:auto;text-align:left}th{padding-top:0.4em}th,td{padding-right:1.4em;vertical-align:top}code{font-family:Inconsolata,monospace;word-break:break-word;background-color:rgba(27,31,35,0.07);padding:0.2em}pre>code{background-color:transparent;padding:0}pre{border:1px solid #4568;color:#456;margin-bottom:0.6rem;margin-top:0.2rem;overflow-x:auto;padding:1rem;padding-left:1.4rem;margin-left:-1.4rem;margin-right:-1.4rem;font-size:0.9rem;line-height:1.4rem}pre:hover{overflow-x:auto}::-webkit-scrollbar{background-color:#fffef8}::-webkit-scrollbar-track{background-color:#fffef8}::-webkit-scrollbar-thumb{background-color:#c35}pre::-webkit-scrollbar-thumb{background-color:#fffef8}pre:hover::-webkit-scrollbar-thumb{background-color:#c35}.kw,.cf{color:#07a}.dt,.at{color:#d56}.op{color:#690}.dv,.bn,.fl,.er{color:#905}.ch,.st{color:#d80}.co{color:#789}blockquote{font-style:italic;padding-left:1em;padding-right:1em}sup,sub{vertical-align:baseline;position:relative}sup{top:-0.4em}sub{top:0.4em}#teaser-section{background-color:#c35;color:#f5b2c8}#teaser p:first-child{margin-bottom:0.3em}#teaser a{color:#fff;font-family:Alegreya,serif;line-height:0}#teaser a:after{color:#fff;content:'\a0»'}#teaser>h2{margin-bottom:0.2rem;padding-top:0.5rem}footer{background-color:#234;color:#b4aaaa}#notices{clear:both;text-align:center;padding-top:1.8em;display:block}#profile-links{clear:both;text-align:center;margin-left:2.5em;display:block}footer span{margin-left:0.25em;margin-right:0.25em}@media(min-width:400px){#content,#teaser,#footer{padding-left:2em;padding-right:2em}h1{font-size:2.0em}}@media(min-width:470px){html{font-size:16px}}@media(min-width:544px){header,#content,#teaser,#footer{padding-left:2.8em;padding-right:2.8em}li{margin-left:0}}@media(min-width:625px){html{font-size:17px}h1>br{display:block}h2>a:before{width:1.6rem;margin-left:-1.6rem}}@media(min-width:802px){html{font-size:18px}h1{font-size:2.4em}header{margin-top:1.4em}}@media(min-width:1003px){html{font-size:19px}h1{font-size:2.6em}}@media(min-width:1225px){#footer{max-width:42em}footer h2{margin-left:3rem}footer nav{float:left;text-align:right;width:6em;margin-left:-5em}#about{float:right;width:36em;margin-right:3em}}@media(max-width:399px){article li:before{margin-left:-0.5em}}@media(max-width:490px){#breakdot{display:block;height:0;overflow:hidden;width:0}li:before{margin-left:-0.95em}#profile-links{margin-left:0}}@media (-webkit-min-device-pixel-ratio:2),(min-device-pixel-ratio:2),(min-resolution:192dpi){pre{border-width:0.5px}}.dark body,.dark ::-webkit-scrollbar,.dark ::-webkit-scrollbar-track,.dark pre::-webkit-scrollbar-thumb{background-color:#1a2633;color:#eee}.dark h1,.dark h2,.dark h3,.dark h2>a:before{color:#eee}.dark .archive h2{color:#577ea8}.dark code{background-color:#eee2}.dark pre{border:1px solid #97a8ba;color:#97a8ba}.dark pre>code{background-color:transparent}.dark a{color:#e05271}.dark hr.hairline{border-bottom:1px solid #e05271}.dark .kw,.dark .cf{color:#07a}.dark .dt,.dark .at{color:#d56}.dark .op{color:#690}.dark .dv,.dark .bn,.dark .fl,.dark .er{color:#e6007e}.dark .ch,.dark .st{color:#d80}.dark .co{color:#789}dark-mode-toggle{position:fixed;top:0;right:0;transform:scale(1.5)}dark-mode-toggle input{outline:none}</style><script async src="https://www.googletagmanager.com/gtag/js?id=UA-126869629-1"></script><script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-126869629-1');</script></head><body><article id="content" itemscope><header><h1>Polymorphic Type-Directed Function Application</h1><p><a href="/" class="author">mgsloan</a><br><time datetime="2021-04-06" itemprop="datePublished">2021-04-06</time></p><hr class="hairline"></header><p><span class="run-in"></span>In <a href="/posts/unordered-apply">"Unordered Function Application In Haskell"</a>, I described an approach to implementing unordered function application in Haskell. This approach only works for monomorphic functions and arguments. Happily, I found a solution to this issue! The goal of this post is just to sketch the solution, not describe it in detail. For more detail, see <a href="https://github.com/mgsloan/apply-unordered/blob/master/apply-unordered/src/Control/Apply/Unordered/Plugin.h">the code</a>.</p><h2 id="the-solution-ghc-plugin---xoverlappinginstances-logic"><a href="#the-solution-ghc-plugin---xoverlappinginstances-logic"></a>The solution: <abbr>GHC</abbr> plugin &amp; -XOverlappingInstances logic</h2><p>Matching arguments to parameters becomes quite ambiguous, so some concept of a "best fit" for an argument needs to be defined. As far as I know, there is no way for type families to work on types generically, and so a general purpose "best-fit" type family cannot be defined.</p><p>The solution I ended up with is to write a <abbr>GHC</abbr> plugin which substitutes uses of a type family with a <a href="https://hackage.haskell.org/package/base/docs/GHC-TypeNats.html#t:Nat"><code>Nat</code></a> indicating which parameter is the "best fit" for the argument.</p><p>The idea is to use the same logic as <a href="https://ghc.gitlab.haskell.org/ghc/doc/users_guide/exts/instances.html#instance-overlap"><code>-XOverlappingInstances</code></a> when determining which parameter is the "best fit" for the argument. In essence, <code>-XOverlappingInstances</code> will select the instance where more of the type's structure matches. The <a href="https://github.com/mgsloan/apply-unordered/blob/111b90ed898648deee97e776752f010ee56877e7/apply-unordered/src/Control/Apply/Unordered/Plugin.hs#L75">code in the plugin</a> for determining the most specific parameter is directly copy-modified from the <a href="https://github.com/ghc/ghc/blob/be3c0d62c73361b8805a51a88770991c3b6f9331/compiler/GHC/Core/InstEnv.hs#L956">code in <abbr>GHC</abbr></a> for selecting an overlapping instance.</p><p>Here's what it looks like to use this package, via running <code>stack GHCi apply-unordered</code> in the <a href="https://github.com/mgsloan/apply-unordered/">apply-unordered repository</a>:</p><div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a><span class="op">&gt;</span> <span class="op">:</span>set <span class="op">-</span>fplugin<span class="ot">=</span><span class="dt">Control.Apply.Unordered.Plugin</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="op">&gt;</span> <span class="op">:</span>m <span class="op">+</span> <span class="dt">Data.List</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="op">&gt;</span> <span class="op">:</span>t intersperse</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="ot">intersperse ::</span> a <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> [a]</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="op">&gt;</span> intersperse <span class="op">?</span> <span class="st">"hello"</span> <span class="op">?</span> <span class="ch">' '</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="st">"h e l l o"</span></span></code></pre></div><p>Whoah! The arguments are provided in swapped order to a polymorphic function, and it worked! For <code>intersperse ? "hello"</code>, it decided to provide "hello" as the second argument, because <code>[a]</code> is the more specific match for <code>[Char]</code> (<code>String</code>). Digging into the type of <code>intersperse ? "hello"</code>:</p><div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a><span class="op">&gt;</span> <span class="op">:</span>t intersperse <span class="op">?</span> <span class="st">"hello"</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>intersperse <span class="op">?</span> <span class="st">"hello"</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="ot">  ::</span> <span class="dt">ApplyAtResult</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>       (<span class="dt">Data.Type.Nat.FromGHC</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>          (<span class="dt">BestParamIxImpl</span> [<span class="dt">Char</span>] (<span class="dt">Char</span> <span class="ot">-&gt;</span> [<span class="dt">Char</span>] <span class="ot">-&gt;</span> [<span class="dt">Char</span>])))</span>
<span id="cb2-6"><a href="#cb2-6"></a>       [<span class="dt">Char</span>]</span>
<span id="cb2-7"><a href="#cb2-7"></a>       (<span class="dt">Char</span> <span class="ot">-&gt;</span> [<span class="dt">Char</span>] <span class="ot">-&gt;</span> [<span class="dt">Char</span>])</span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="op">&gt;</span> intersperse <span class="op">?</span> <span class="st">"hello"</span></span>
<span id="cb2-9"><a href="#cb2-9"></a></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="op">&lt;</span>interactive<span class="op">&gt;:</span><span class="dv">13</span><span class="op">:</span><span class="dv">1</span><span class="op">:</span> <span class="fu">error</span><span class="op">:</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>    • <span class="dt">No</span> <span class="kw">instance</span> for (<span class="dt">Show</span> (<span class="dt">Char</span> <span class="ot">-&gt;</span> [<span class="dt">Char</span>]))</span>
<span id="cb2-12"><a href="#cb2-12"></a>    <span class="op">...</span></span></code></pre></div><p>As expected, the normalized type is <code>Char -&gt; [Char]</code>. The unnormalized type is more more complicated, and involves an <code>ApplyAtResult</code> type family and a <code>BestParamIxImpl</code> type family. The <abbr>GHC</abbr> plugin magically replaces <code>BestParamIxImpl</code> type family with a type-level integer indicating the parameter index the argument should be applied to.</p><p>This approach, a plugin which replaces the type family, was based on an approach copy-modified from Sandy Maguire's <a href>magic-tyfams package</a>.</p><p><a href="https://github.com/mgsloan/apply-unordered/blob/master/apply-unordered/src/Control/Apply/Positional.hs"><code>ApplyAt</code></a> type-class machinery is then used to generate the code which plumbs the argument to the parameter. This is similar to <a href="https://github.com/mgsloan/apply-unordered/blob/111b90ed898648deee97e776752f010ee56877e7/apply-unordered-mono/src/Control/Apply/Unordered/Mono.hs#L134"><code>ApplyByType</code></a>, but directed by a <code>Nat</code> rather than checking for matching types. Here is how this machinery is defined:</p><div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1"></a><span class="co">-- | Typeclass used to implement 'applyN'. The first type argument is</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="co">-- the number of arguments to skip before doing the application.</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="kw">class</span> <span class="dt">ApplyAt</span> (<span class="ot">n ::</span> <span class="dt">Nat</span>) a f <span class="kw">where</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>  <span class="kw">type</span> <span class="dt">ApplyAtResult</span> n a f</span>
<span id="cb3-5"><a href="#cb3-5"></a>  applyAtImpl</span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="ot">    ::</span> <span class="dt">Proxy</span> n</span>
<span id="cb3-7"><a href="#cb3-7"></a>    <span class="ot">-&gt;</span> f</span>
<span id="cb3-8"><a href="#cb3-8"></a>    <span class="ot">-&gt;</span> a</span>
<span id="cb3-9"><a href="#cb3-9"></a>    <span class="ot">-&gt;</span> <span class="dt">ApplyAtResult</span> n a f</span>
<span id="cb3-10"><a href="#cb3-10"></a></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="kw">instance</span> a <span class="op">~</span> b <span class="ot">=&gt;</span> <span class="dt">ApplyAt</span> <span class="dt">Z</span> a (b <span class="ot">-&gt;</span> r) <span class="kw">where</span></span>
<span id="cb3-12"><a href="#cb3-12"></a>  <span class="kw">type</span> <span class="dt">ApplyAtResult</span> <span class="dt">Z</span> a (b <span class="ot">-&gt;</span> r) <span class="ot">=</span> r</span>
<span id="cb3-13"><a href="#cb3-13"></a>  applyAtImpl _ f x <span class="ot">=</span> f x</span>
<span id="cb3-14"><a href="#cb3-14"></a></span>
<span id="cb3-15"><a href="#cb3-15"></a><span class="kw">instance</span> <span class="dt">ApplyAt</span> n a r</span>
<span id="cb3-16"><a href="#cb3-16"></a>      <span class="ot">=&gt;</span> <span class="dt">ApplyAt</span> (<span class="dt">S</span> n) a (b <span class="ot">-&gt;</span> r) <span class="kw">where</span></span>
<span id="cb3-17"><a href="#cb3-17"></a>  <span class="kw">type</span> <span class="dt">ApplyAtResult</span> (<span class="dt">S</span> n) a (b <span class="ot">-&gt;</span> r) <span class="ot">=</span> b <span class="ot">-&gt;</span> <span class="dt">ApplyAtResult</span> n a r</span>
<span id="cb3-18"><a href="#cb3-18"></a>  applyAtImpl _ f y <span class="ot">=</span> \x <span class="ot">-&gt;</span> applyAtImpl (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> n) (f x) y</span></code></pre></div></article><section id="teaser-section"><div id="teaser"><p class="smcp">More words</p><h2><a href="/posts/unordered-apply-type-errors/">Custom Type Errors for Unordered Function Application</a></h2><p>Better type errors via <abbr>GHC</abbr>'s custom type errors. <a href="/posts/unordered-apply-type-errors/" class="smcp">Read</a></p></div></section><footer><div id="footer"><p id="notices" class="smcp"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Copyleft 2018-2021</a> <span id="breakdot">·</span> <a rel="author" href="https://mgsloan.com">Michael G Sloan</a> <span id="breakdot">·</span> <a href="https://github.com/mgsloan/mgsloan-site">Site Code</a> <span id="breakdot">·</span> <a href="/feed.xml">Feed</a></p><p id="profile-links" class="smcp"><a href="https://github.com/mgsloan">GitHub</a> <span id="breakdot">·</span> <a href="https://twitter.com/treetopian">Twitter</a></p></div></footer><dark-mode-toggle></dark-mode-toggle><script type="module" src="/dark-mode-toggle.mjs"></script><script>const toggle = document.querySelector('dark-mode-toggle'); const html = document.documentElement; toggle.addEventListener('colorschemechange', () => { html.classList.toggle('dark', toggle.mode === 'dark'); });</script></body></html>