<!DOCTYPE html><html class="dark"><head><meta charset="utf-8"><title>GHCinception: Running GHCi in GHCi</title><meta name="og:title" content="GHCinception: Running GHCi in GHCi"><meta property="og:image" content="https://mgsloan.com/images/haskell-placeholder-banner.jpg"><meta property="og:site_name" content="mgsloan"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="treetopian"><link href="/favicon.png" rel="icon" type="image/png"><link href="/feed.xml" rel="alternate" type="application/atom+xml"><link href="https://mgsloan.com/posts/ghcinception" rel="canonical"><meta name="description" content="My patches were merged, allowing GHC to be loaded into GHCi and run!"><meta name="og:description" content="My patches were merged, allowing GHC to be loaded into GHCi and run!"><meta name="author" content="Michael G Sloan"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://fonts.googleapis.com/css?family=Alegreya:700|Alegreya+Sans:400,400i,700|Alegreya+Sans+SC:400|Inconsolata:400,700|Playfair+Display:400,700" rel="stylesheet"><style>*{margin:0;padding:0}code,em,strong{line-height:1}html{font-size:16px;zoom:1.15;background-color:#234}body{background-color:#fffef8;padding-top:0.2em;color:#456;font-family:'Alegreya Sans',sans-serif;font-feature-settings:'liga','kern';line-height:1.6}#content,#teaser,#footer{padding:1.4em;margin-left:auto;margin-right:auto;max-width:36em}#content{padding-top:0;min-height:-moz-available;min-height:-webkit-fill-available;min-height:fill-available}header{font-family:'Playfair Display',sans;margin-left:1em;margin-right:1em;overflow:visible;text-align:center;margin-bottom:1.0em}h1{font-family:'Playfair Display',serif;color:#000;font-size:1.8em;line-height:3.8rem;margin-bottom:0.7rem;padding-top:2.8rem}header>h2{font-feature-settings:'dlig';font-size:1.4em;font-style:italic;font-weight:normal;line-height:1.4rem;margin-bottom:1.0rem;padding-top:0.4rem}header>p{padding-top:0.5em;padding-bottom:0.9em;margin-bottom:0}article>header>hr.hairline{margin-top:0.5em;transform:scale(1.3,0.5)}article hr.hairline{transform:scale(1.09,0.5)}hr.hairline{border:none;border-bottom:1px solid #c35;transform:scale(1,0.5)}.footnotes-divider{margin-top:3.4em;margin-bottom:2.4em}h1>br{display:none}p,nav{margin-bottom:1em;padding-top:0.4em}a{color:#c35;text-decoration:none}abbr,.smcp{font-family:"Alegreya Sans SC";letter-spacing:0.1em;display:inline-block}abbr{letter-spacing:0.03em;margin-right:-0.03em}.run-in{font-family:"Alegreya Sans SC";letter-spacing:0.05em}h2{font-family:Alegreya,serif;font-size:1.4em;line-height:1em;margin-bottom:0.2rem;padding-top:1.2rem}h2>a:before{content:'¶';width:1.2rem;margin-left:-1.2rem;display:inline-block;opacity:0;transition:opacity 0.2s ease-out;color:#b4aaaa}h2:hover>a:before{opacity:1}h2:target>a:before{opacity:1;color:#c35}ul,ol{counter-reset:ol;list-style:none;margin-top:1em}li{position:relative}li:before{display:inline-block;margin-left:-1em;width:1em;position:absolute;top:0}ul>li:before{content:'•';font-weight:bold;transform:scale(1.6);top:-0.15em}ul.affiliate>li:before{content:'$';transform:scale(1)}ol>li:before{content:counter(ol,decimal);counter-increment:ol;font-weight:bold;top:-0.05em}li>p:first-child{display:inline-block;padding-top:0}li>p:first-child + *{margin-top:0}li>ul,li>ol{margin-left:1em}li>ul>li:before{content:"■";transform:scale(0.5);top:-0.05em}table{border-spacing:0;margin-bottom:1em;margin-left:auto;margin-right:auto;text-align:left}th{padding-top:0.4em}th,td{padding-right:1.4em;vertical-align:top}code{font-family:Inconsolata,monospace;word-break:break-word;background-color:rgba(27,31,35,0.07);padding:0.2em}pre>code{background-color:transparent;padding:0}pre{border:1px solid #4568;color:#456;margin-bottom:0.6rem;margin-top:0.2rem;overflow-x:auto;padding:1rem;padding-left:1.4rem;margin-left:-1.4rem;margin-right:-1.4rem;font-size:0.9rem;line-height:1.4rem}pre:hover{overflow-x:auto}::-webkit-scrollbar{background-color:#fffef8}::-webkit-scrollbar-track{background-color:#fffef8}::-webkit-scrollbar-thumb{background-color:#c35}pre::-webkit-scrollbar-thumb{background-color:#fffef8}pre:hover::-webkit-scrollbar-thumb{background-color:#c35}.kw,.cf{color:#07a}.dt,.at{color:#d56}.op{color:#690}.dv,.bn,.fl,.er{color:#905}.ch,.st{color:#d80}.co{color:#789}img{width:100%;height:auto;margin-top:-0.2em;margin-bottom:-0.6em}blockquote{font-style:italic;padding-left:1em;padding-right:1em}sup,sub{vertical-align:baseline;position:relative}sup{top:-0.4em}sub{top:0.4em}#teaser-section{background-color:#c35;color:#f5b2c8}#teaser p:first-child{margin-bottom:0.3em}#teaser a{color:#fff;font-family:Alegreya,serif;line-height:0}#teaser a:after{color:#fff;content:'\a0»'}#teaser>h2{margin-bottom:0.2rem;padding-top:0.5rem}footer{background-color:#234;color:#b4aaaa}#notices{clear:both;text-align:center;padding-top:1.8em;display:block}#profile-links{clear:both;text-align:center;margin-left:2.5em;display:block}footer span{margin-left:0.25em;margin-right:0.25em}@media(min-width:400px){#content,#teaser,#footer{padding-left:2em;padding-right:2em}h1{font-size:2.0em}}@media(min-width:470px){html{font-size:16px}header{margin-left:2.8em;margin-right:2.8em}}@media(min-width:544px){#content,#teaser,#footer{padding-left:2.8em;padding-right:2.8em}li{margin-left:0}}@media(min-width:625px){html{font-size:17px}h1>br{display:block}h2>a:before{width:1.6rem;margin-left:-1.6rem}}@media(min-width:802px){html{font-size:18px}h1{font-size:2.4em}header{margin-top:1.4em}}@media(min-width:1003px){html{font-size:19px}h1{font-size:2.6em}}@media(min-width:1225px){#footer{max-width:42em}footer h2{margin-left:3rem}footer nav{float:left;text-align:right;width:6em;margin-left:-5em}#about{float:right;width:36em;margin-right:3em}}@media(max-width:399px){article li:before{margin-left:-0.5em}}@media(max-width:490px){#breakdot{display:block;height:0;overflow:hidden;width:0}li:before{margin-left:-0.95em}#profile-links{margin-left:0}}@media (-webkit-min-device-pixel-ratio:2),(min-device-pixel-ratio:2),(min-resolution:192dpi){pre{border-width:0.5px}}.dark body,.dark ::-webkit-scrollbar,.dark ::-webkit-scrollbar-track,.dark pre::-webkit-scrollbar-thumb{background-color:#1a2633;color:#eee}.dark h1,.dark h2,.dark h3,.dark h2>a:before{color:#fff}.dark .archive h2{}.dark code{background-color:#eee2}.dark pre{border:1px solid #97a8ba;color:#97a8ba}.dark pre>code{background-color:transparent}.dark a{color:#e05271}.dark hr.hairline{border-bottom:1px solid #e05271}.dark .kw,.dark .cf{color:#07a}.dark .dt,.dark .at{color:#d56}.dark .op{color:#690}.dark .dv,.dark .bn,.dark .fl,.dark .er{color:#e6007e}.dark .ch,.dark .st{color:#d80}.dark .co{color:#789}dark-mode-toggle{position:fixed;top:0;right:0;transform:scale(1.5)}dark-mode-toggle input{outline:none}</style><script async src="https://www.googletagmanager.com/gtag/js?id=UA-126869629-1"></script><script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-126869629-1');</script></head><body><article id="content" itemscope><header><h1>GHCinception:<br> Running <abbr>GHCi</abbr> in <abbr>GHCi</abbr></h1><p><a href="/" class="author">mgsloan</a><br><time datetime="2018-07-28" itemprop="datePublished">2018-07-28</time></p><hr class="hairline"></header><p>I'm happy to announce that you can now easily load <abbr>GHC</abbr> into <abbr>GHCi</abbr>! I've been using this for about a month now, and for me it makes <abbr>GHC</abbr> development far more pleasant than using <code>make</code>. This can often lead to iteration times of only <strong>10-30 seconds</strong> to try out some modified behavior.</p><p>For me, <abbr>GHCi</abbr> usage is crucial to efficient Haskell development. One larger project I work on takes a whopping 15 minutes to build, whereas loading the same code in <abbr>GHCi</abbr> takes a little bit less than 1 minute.</p><p><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/ghci.html"><abbr>GHCi</abbr></a> is quite a marvelous thing. Despite being an interpreter, it can run complicated programs quite quickly and correctly – I typically barely notice a difference in performance. One of the main reasons for this is that it still uses the compiled code for your dependencies. It also lets you conveniently query lots of information and try things out in a <a href="https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop"><abbr>REPL</abbr></a>.</p><h2 id="how-to-load-ghc-into-ghci"><a href="#how-to-load-ghc-into-ghci"></a>How to load <abbr>GHC</abbr> into <abbr>GHCi</abbr></h2><p>If you have a recent checkout of <abbr>GHC</abbr>, and have built the <abbr>GHC</abbr> stage 2 compiler located at <code>/inplace/bin/ghc-stage2</code>, then you can do the following to load <abbr>GHC</abbr> into <abbr>GHCi</abbr>:</p><pre><code>$ ./utils/ghc-in-ghci/run.sh -j8</code></pre><p>Tweak the <code>N</code> in <code>-jN</code> as is suitable for your system – it indicates the degree of module-level build parallelism. The number of logical cores you have is a reasonable guideline.</p><p>This should result in <abbr>GHCi</abbr> loading up the code for <abbr>GHC</abbr>:</p><div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a>mgsloan<span class="op">@</span>treetop<span class="op">:~/</span>oss<span class="op">/</span>haskell<span class="op">/</span>ghc<span class="op">$</span> <span class="op">./</span>utils<span class="op">/</span>ghc<span class="op">-</span><span class="kw">in</span><span class="op">-</span>ghci<span class="op">/</span>run<span class="op">.</span>sh <span class="op">-</span>fobject<span class="op">-</span>code <span class="op">-</span>j8</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="op">+</span> export _GHC_TOP_DIR<span class="op">=./</span>inplace<span class="op">/</span>lib</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="op">+</span> exec <span class="op">./</span>inplace<span class="op">/</span>bin<span class="op">/</span>ghc<span class="op">-</span>stage2 <span class="co">--interactive -ghci-script ./utils/ghc-in-ghci/settings.ghci -ghci-script ./utils/ghc-in-ghci/load-main.ghci -odir ./ghci-tmp -hidir ./ghci-tmp +RTS -A128m -RTS -fobject-code</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="dt">GHCi</span>, version <span class="fl">8.7</span><span class="op">.</span><span class="dv">20180718</span><span class="op">:</span> http<span class="op">://</span>www<span class="op">.</span>haskell<span class="op">.</span>org<span class="op">/</span>ghc<span class="op">/</span>  <span class="op">:?</span> for help</span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="dt">Loaded</span> <span class="dt">GHCi</span> configuration from <span class="op">/</span>home<span class="op">/</span>mgsloan<span class="op">/.</span>ghci</span>
<span id="cb2-6"><a href="#cb2-6"></a>package flags have changed, resetting <span class="fu">and</span> loading new packages<span class="op">...</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="dt">Loaded</span> <span class="dt">GHCi</span> configuration from <span class="op">./</span>utils<span class="op">/</span>ghc<span class="op">-</span><span class="kw">in</span><span class="op">-</span>ghci<span class="op">/</span>settings<span class="op">.</span>ghci</span>
<span id="cb2-8"><a href="#cb2-8"></a>[  <span class="dv">1</span> <span class="kw">of</span> <span class="dv">493</span>] <span class="dt">Compiling</span> <span class="dt">GhcPrelude</span>       ( compiler<span class="op">/</span>utils<span class="op">/</span>GhcPrelude.hs, ghci<span class="op">-</span>tmp<span class="op">/</span>GhcPrelude.o )</span>
<span id="cb2-9"><a href="#cb2-9"></a>[  <span class="dv">2</span> <span class="kw">of</span> <span class="dv">493</span>] <span class="dt">Compiling</span> <span class="dt">FiniteMap</span>        ( compiler<span class="op">/</span>utils<span class="op">/</span>FiniteMap.hs, ghci<span class="op">-</span>tmp<span class="op">/</span>FiniteMap.o )</span>
<span id="cb2-10"><a href="#cb2-10"></a>[  <span class="dv">3</span> <span class="kw">of</span> <span class="dv">493</span>] <span class="dt">Compiling</span> <span class="dt">FastMutInt</span>       ( compiler<span class="op">/</span>utils<span class="op">/</span>FastMutInt.hs, ghci<span class="op">-</span>tmp<span class="op">/</span>FastMutInt.o )</span>
<span id="cb2-11"><a href="#cb2-11"></a>[  <span class="dv">4</span> <span class="kw">of</span> <span class="dv">493</span>] <span class="dt">Compiling</span> <span class="dt">FastFunctions</span>    ( compiler<span class="op">/</span>utils<span class="op">/</span>FastFunctions.hs, ghci<span class="op">-</span>tmp<span class="op">/</span>FastFunctions.o )</span>
<span id="cb2-12"><a href="#cb2-12"></a>[  <span class="dv">5</span> <span class="kw">of</span> <span class="dv">493</span>] <span class="dt">Compiling</span> <span class="dt">Exception</span>        ( compiler<span class="op">/</span>utils<span class="op">/</span>Exception.hs, ghci<span class="op">-</span>tmp<span class="op">/</span>Exception.o )</span>
<span id="cb2-13"><a href="#cb2-13"></a>[  <span class="dv">6</span> <span class="kw">of</span> <span class="dv">493</span>] <span class="dt">Compiling</span> <span class="dt">EnumSet</span>          ( compiler<span class="op">/</span>utils<span class="op">/</span>EnumSet.hs, ghci<span class="op">-</span>tmp<span class="op">/</span>EnumSet.o )</span>
<span id="cb2-14"><a href="#cb2-14"></a>[  <span class="dv">7</span> <span class="kw">of</span> <span class="dv">493</span>] <span class="dt">Compiling</span> <span class="dt">Encoding</span>         ( compiler<span class="op">/</span>utils<span class="op">/</span>Encoding.hs, ghci<span class="op">-</span>tmp<span class="op">/</span>Encoding.o )</span>
<span id="cb2-15"><a href="#cb2-15"></a><span class="op">...</span></span></code></pre></div><p>This takes a while to load, since it's loading 493 modules. On my machine it clocks in at around 8 minutes. The main reason that this takes so long is that it needs to do object code generation. I bet it'd also load faster if I wasn't using an unoptimized <code>devel2</code> flavour build of <code>ghc-stage2</code>. This flavour includes potentially expensive assertions.</p><p>Once it has finished loading, you can use <abbr>GHCi</abbr> to ask for information as usual! For example, let's take a look at the datatype for a core expression:</p><div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1"></a><span class="dt">Ok</span>, <span class="dv">493</span> modules loaded<span class="op">.</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="dt">Loaded</span> <span class="dt">GHCi</span> configuration from <span class="op">./</span>utils<span class="op">/</span>ghc<span class="op">-</span><span class="kw">in</span><span class="op">-</span>ghci<span class="op">/</span>load<span class="op">-</span>main<span class="op">.</span>ghci</span>
<span id="cb3-3"><a href="#cb3-3"></a>λ <span class="op">:</span>m <span class="op">+</span> <span class="dt">CoreSyn</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>λ <span class="op">:</span>info <span class="dt">Expr</span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="kw">data</span> <span class="dt">Expr</span> b</span>
<span id="cb3-6"><a href="#cb3-6"></a>  <span class="ot">=</span> <span class="dt">Var</span> <span class="dt">Var.Id</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>  <span class="op">|</span> <span class="dt">Lit</span> <span class="dt">Literal.Literal</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>  <span class="op">|</span> <span class="dt">App</span> (<span class="dt">Expr</span> b) (<span class="dt">Arg</span> b)</span>
<span id="cb3-9"><a href="#cb3-9"></a>  <span class="op">|</span> <span class="dt">Lam</span> b (<span class="dt">Expr</span> b)</span>
<span id="cb3-10"><a href="#cb3-10"></a>  <span class="op">|</span> <span class="dt">Let</span> (<span class="dt">Bind</span> b) (<span class="dt">Expr</span> b)</span>
<span id="cb3-11"><a href="#cb3-11"></a>  <span class="op">|</span> <span class="dt">Case</span> (<span class="dt">Expr</span> b) b <span class="dt">TyCoRep.Type</span> [<span class="dt">Alt</span> b]</span>
<span id="cb3-12"><a href="#cb3-12"></a>  <span class="op">|</span> <span class="dt">Cast</span> (<span class="dt">Expr</span> b) <span class="dt">TyCoRep.Coercion</span></span>
<span id="cb3-13"><a href="#cb3-13"></a>  <span class="op">|</span> <span class="dt">Tick</span> (<span class="dt">Tickish</span> <span class="dt">Var.Id</span>) (<span class="dt">Expr</span> b)</span>
<span id="cb3-14"><a href="#cb3-14"></a>  <span class="op">|</span> <span class="dt">Type</span> <span class="dt">TyCoRep.Type</span></span>
<span id="cb3-15"><a href="#cb3-15"></a>  <span class="op">|</span> <span class="dt">Coercion</span> <span class="dt">TyCoRep.Coercion</span></span></code></pre></div><p>Beautiful! While <code>-fobject-code</code> does take quite a while to do an initial load, subsequent loads can be very fast. For me, with no code changes, it only takes about <strong>7 seconds</strong>.</p><h2 id="how-to-run-ghci-within-ghci"><a href="#how-to-run-ghci-within-ghci"></a>How to run <abbr>GHCi</abbr> within <abbr>GHCi</abbr></h2><p>The ghci script sets up some default arguments:</p><pre><code>:set args --interactive -ghci-script utils/ghc-in-ghci/inner.ghci</code></pre><p>Due to these defaults, just running <code>main</code> brings up a nested <abbr>GHCi</abbr>:</p><div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1"></a>λ main</span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="dt">GHCi</span>, version <span class="fl">8.7</span><span class="op">.</span><span class="dv">20180718</span><span class="op">:</span> http<span class="op">://</span>www<span class="op">.</span>haskell<span class="op">.</span>org<span class="op">/</span>ghc<span class="op">/</span>  <span class="op">:?</span> for help</span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="dt">Loaded</span> <span class="dt">GHCi</span> configuration from <span class="op">/</span>home<span class="op">/</span>mgsloan<span class="op">/.</span>ghci</span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="dt">Loaded</span> <span class="dt">GHCi</span> configuration from utils<span class="op">/</span>ghc<span class="op">-</span><span class="kw">in</span><span class="op">-</span>ghci<span class="op">/</span>inner<span class="op">.</span>ghci</span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="dt">Prelude</span> [inner]<span class="op">&gt;</span> <span class="op">:</span>{</span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="dt">Prelude</span><span class="op">|</span> <span class="fu">putStrLn</span> <span class="op">$</span> <span class="fu">unwords</span> <span class="op">$</span></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="dt">Prelude</span><span class="op">|</span> <span class="st">"Wow, we're evaluating code"</span> <span class="op">:</span> <span class="fu">replicate</span> <span class="dv">2</span> <span class="st">"*inside* GHCi"</span></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="dt">Prelude</span><span class="op">|</span> <span class="op">:</span>}</span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="dt">Wow</span>, we're evaluating code <span class="op">*</span>inside<span class="op">*</span> <span class="dt">GHCi</span> <span class="op">*</span>inside<span class="op">*</span> <span class="dt">GHCi</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="dt">Prelude</span> [inner]<span class="op">&gt;</span></span></code></pre></div><p>There's a different <abbr>GHCi</abbr> prompt there because the <code>inner.ghci</code> contains</p><div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1"></a><span class="op">:</span>set prompt <span class="st">"%s [inner]&gt; "</span></span></code></pre></div><p>When using this for development, I found that it was helpful to distinguish the inner ghci prompt from the outer.</p><h2 id="modifying-reloading-and-trying-some-new-behavior"><a href="#modifying-reloading-and-trying-some-new-behavior"></a>Modifying, reloading, and trying some new behavior</h2><p>Lets say I want to <a href="https://github.com/ghc-proposals/ghc-proposals/pull/156">change some type error messages</a>. First, I make a change to the code:</p><div class="sourceCode" id="cb7"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">diff --git a/compiler/typecheck/TcErrors.hs b/compiler/typecheck/TcErrors.hs</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>index ecb404289a..32d7cffaab 100644</span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="dt">--- a/compiler/typecheck/TcErrors.hs</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="dt">+++ b/compiler/typecheck/TcErrors.hs</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="dt">@@ -1894,11 +1894,11 @@ misMatchMsg ct oriented ty1 ty2</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>   where</span>
<span id="cb7-7"><a href="#cb7-7"></a>     herald1 = conc [ "Couldn't match"</span>
<span id="cb7-8"><a href="#cb7-8"></a>                    , if is_repr     then "representation of" else ""</span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="st">-                   , if is_oriented then "expected"          else ""</span></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="va">+                   , if is_oriented then "wanted"            else ""</span></span>
<span id="cb7-11"><a href="#cb7-11"></a>                    , what ]</span>
<span id="cb7-12"><a href="#cb7-12"></a>     herald2 = conc [ "with"</span>
<span id="cb7-13"><a href="#cb7-13"></a>                    , if is_repr     then "that of"           else ""</span>
<span id="cb7-14"><a href="#cb7-14"></a><span class="st">-                   , if is_oriented then ("actual " ++ what) else "" ]</span></span>
<span id="cb7-15"><a href="#cb7-15"></a><span class="va">+                   , if is_oriented then ("found " ++ what)  else "" ]</span></span>
<span id="cb7-16"><a href="#cb7-16"></a>     padding = length herald1 - length herald2</span>
<span id="cb7-17"><a href="#cb7-17"></a></span>
<span id="cb7-18"><a href="#cb7-18"></a>     is_repr = case ctEqRel ct of { ReprEq -&gt; True; NomEq -&gt; False }</span></code></pre></div><p>Then I do a reload, run the inner <abbr>GHCi</abbr>, and try it out:</p><div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1"></a>λ <span class="op">:</span>r</span>
<span id="cb8-2"><a href="#cb8-2"></a>[ <span class="dv">22</span> <span class="kw">of</span> <span class="dv">493</span>] <span class="dt">Compiling</span> <span class="dt">Hooks</span>[boot]      ( compiler<span class="op">/</span>main<span class="op">/</span>Hooks.hs<span class="op">-</span>boot, ghci<span class="op">-</span>tmp<span class="op">/</span>Hooks.o<span class="op">-</span>boot )</span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="op">...</span> <span class="dt">Omitted</span> about <span class="dv">40</span> boot modules that load really quickly <span class="op">...</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>[<span class="dv">377</span> <span class="kw">of</span> <span class="dv">493</span>] <span class="dt">Compiling</span> <span class="dt">TcErrors</span>         ( compiler<span class="op">/</span>typecheck<span class="op">/</span>TcErrors.hs, ghci<span class="op">-</span>tmp<span class="op">/</span>TcErrors.o )</span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="op">...</span> <span class="dt">A</span> few more boot modules <span class="op">...</span></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="dt">Ok</span>, <span class="dv">493</span> modules loaded<span class="op">.</span></span>
<span id="cb8-7"><a href="#cb8-7"></a>λ</span></code></pre></div><p>This only took about <strong>8 seconds</strong>!!! Invoking the inner <abbr>GHCi</abbr> takes <strong>less than a second</strong>:</p><div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1"></a>λ main</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="dt">GHCi</span>, version <span class="fl">8.7</span><span class="op">.</span><span class="dv">20180718</span><span class="op">:</span> http<span class="op">://</span>www<span class="op">.</span>haskell<span class="op">.</span>org<span class="op">/</span>ghc<span class="op">/</span>  <span class="op">:?</span> for help</span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="dt">Loaded</span> <span class="dt">GHCi</span> configuration from <span class="op">/</span>home<span class="op">/</span>mgsloan<span class="op">/.</span>ghci</span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="dt">Loaded</span> <span class="dt">GHCi</span> configuration from utils<span class="op">/</span>ghc<span class="op">-</span><span class="kw">in</span><span class="op">-</span>ghci<span class="op">/</span>inner<span class="op">.</span>ghci</span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="dt">Prelude</span> [inner]<span class="op">&gt;</span> <span class="st">"testing"</span> <span class="op">++</span> <span class="dt">Nothing</span></span>
<span id="cb9-6"><a href="#cb9-6"></a></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="op">&lt;</span>interactive<span class="op">&gt;:</span><span class="dv">1</span><span class="op">:</span><span class="dv">14</span><span class="op">:</span> <span class="fu">error</span><span class="op">:</span></span>
<span id="cb9-8"><a href="#cb9-8"></a>    • <span class="dt">Couldn't</span> match wanted <span class="kw">type</span> ‘[<span class="dt">Char</span>]’ with found <span class="kw">type</span> ‘<span class="dt">Maybe</span> a0’</span>
<span id="cb9-9"><a href="#cb9-9"></a>    • <span class="dt">In</span> the second argument <span class="kw">of</span> ‘(<span class="op">++</span>)’, namely ‘<span class="dt">Nothing</span>’</span>
<span id="cb9-10"><a href="#cb9-10"></a>      <span class="dt">In</span> the expression<span class="op">:</span> <span class="st">"testing"</span> <span class="op">++</span> <span class="dt">Nothing</span></span>
<span id="cb9-11"><a href="#cb9-11"></a>      <span class="dt">In</span> an equation for ‘it’<span class="op">:</span> it <span class="ot">=</span> <span class="st">"testing"</span> <span class="op">++</span> <span class="dt">Nothing</span></span>
<span id="cb9-12"><a href="#cb9-12"></a><span class="dt">Prelude</span> [inner]<span class="op">&gt;</span></span></code></pre></div><p>For me, this is a game changer for <abbr>GHC</abbr> development. In particular, this means that you can make a change and very rapidly try out the change in behavior. On my machine, it often takes <strong>less than 10 seconds to make a change and try it out</strong>. This is drastically faster than <code>make</code> – I'm not even going to try, but I'm pretty sure I'd be waiting around for a few minutes.</p><h2 id="changes-made-to-ghc-for-this"><a href="#changes-made-to-ghc-for-this"></a>Changes made to <abbr>GHC</abbr> for this</h2><p>I opened a couple patches to <abbr>GHC</abbr> that got merged yesterday:</p><ul><li><p><a href="https://phabricator.haskell.org/D4904">D4904</a>, which adds a shell script and some ghci scripts for this. Most of of <code>settings.ghci</code> was written by Csongor Kiss – I found out about them via a <a href="https://mail.haskell.org/pipermail/ghc-devs/2018-May/015810.html">helpful mailing list post</a> from Matthew Pickering. I also incorporated some <abbr>RTS</abbr> arguments <a href="https://mail.haskell.org/pipermail/ghc-devs/2018-June/015844.html">suggested by Simon Marlow</a>. My main additions were making it so that <abbr>GHCi</abbr> could run inside of <abbr>GHCi</abbr>, and putting up a <abbr>GHC</abbr> differential.</p></li><li><p><a href="https://phabricator.haskell.org/D4986">D4986</a>, which makes some code changes to <abbr>GHC</abbr> that allow it all to be loaded into <abbr>GHCi</abbr> at once. These changes have no effect on the normal build.</p></li><li><p><a href="https://phabricator.haskell.org/D5015">D5015</a>, fix adding back in <code>-fobject-code</code>, which is needed due to use of unboxed tuples.</p></li></ul><h2 id="next-steps"><a href="#next-steps"></a>Next steps</h2><ul><li><p>I'm planning to do an optimized build of <code>ghc-stage2</code>, and use that instead. It may even make sense to have the ghci script use a different path if it exists, so that I can keep around an optimized <code>ghc-stage2</code>.</p></li><li><p>It would be really nice if <code>-fobject-code</code> wasn't needed to load code that uses <code>UnboxedTuples</code>. I have opened <a href="https://ghc.haskell.org/trac/ghc/ticket/15454">trac#15454</a> about adding some automagic to <abbr>GHCi</abbr> which would intelligently build just enough <code>-fobject-code</code> modules to handle the unboxed tuples, and use byte-code for everything else.</p></li><li><p>Are nightly builds of <abbr>GHC</abbr> downloadable from somewhere? If there are, then the following workflow could work for newcomers to <abbr>GHC</abbr> development:</p><ul><li><p>Download nightly build of <abbr>GHC</abbr></p></li><li><p>Load <abbr>GHC</abbr> into <abbr>GHCi</abbr> in ~10 minutes or less. I think that this would be <em>far</em> more appealing than the current recommended approach for newcomers, which is something like a 30 or 40 minute build process on my machine.</p></li></ul></li></ul><h2 id="can-we-go-three-layers-deep-does-time-slow-down"><a href="#can-we-go-three-layers-deep-does-time-slow-down"></a>Can we go three layers deep? Does time slow down?</h2><p><img src="./images/inception.jpg" alt="inception screenshot" width="1200" height="505"></p><p>A natural question is how deep can we go? Can <abbr>GHCi</abbr> run inside <abbr>GHCi</abbr> inside <abbr>GHCi</abbr>?! It turns out that it works directly, and the nesting works arbitrarily deep:</p><div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1"></a><span class="dt">Prelude</span> [inner]<span class="op">&gt;</span> <span class="op">:</span>script utils<span class="op">/</span>ghc<span class="op">-</span><span class="kw">in</span><span class="op">-</span>ghci<span class="op">/</span>settings<span class="op">.</span>ghci</span>
<span id="cb10-2"><a href="#cb10-2"></a>package flags have changed, resetting <span class="fu">and</span> loading new packages<span class="op">...</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="dt">Prelude</span> [inner]<span class="op">&gt;</span> <span class="op">:</span>load <span class="dt">Main</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="dt">Ok</span>, <span class="dv">493</span> modules loaded<span class="op">.</span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="dt">Main</span> [inner]<span class="op">&gt;</span> main</span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="dt">GHCi</span>, version <span class="fl">8.7</span><span class="op">.</span><span class="dv">20180718</span><span class="op">:</span> http<span class="op">://</span>www<span class="op">.</span>haskell<span class="op">.</span>org<span class="op">/</span>ghc<span class="op">/</span>  <span class="op">:?</span> for help</span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="dt">Loaded</span> <span class="dt">GHCi</span> configuration from <span class="op">/</span>home<span class="op">/</span>mgsloan<span class="op">/.</span>ghci</span>
<span id="cb10-8"><a href="#cb10-8"></a><span class="dt">Loaded</span> <span class="dt">GHCi</span> configuration from utils<span class="op">/</span>ghc<span class="op">-</span><span class="kw">in</span><span class="op">-</span>ghci<span class="op">/</span>inner<span class="op">.</span>ghci</span>
<span id="cb10-9"><a href="#cb10-9"></a><span class="dt">Prelude</span> [inner]<span class="op">&gt;</span> <span class="op">:</span>script utils<span class="op">/</span>ghc<span class="op">-</span><span class="kw">in</span><span class="op">-</span>ghci<span class="op">/</span>settings<span class="op">.</span>ghci</span>
<span id="cb10-10"><a href="#cb10-10"></a>package flags have changed, resetting <span class="fu">and</span> loading new packages<span class="op">...</span></span>
<span id="cb10-11"><a href="#cb10-11"></a><span class="dt">Prelude</span> [inner]<span class="op">&gt;</span> <span class="op">:</span>load <span class="dt">Main</span></span>
<span id="cb10-12"><a href="#cb10-12"></a><span class="dt">Ok</span>, <span class="dv">493</span> modules loaded<span class="op">.</span></span>
<span id="cb10-13"><a href="#cb10-13"></a><span class="dt">Main</span> [inner]<span class="op">&gt;</span> main</span>
<span id="cb10-14"><a href="#cb10-14"></a><span class="dt">GHCi</span>, version <span class="fl">8.7</span><span class="op">.</span><span class="dv">20180718</span><span class="op">:</span> http<span class="op">://</span>www<span class="op">.</span>haskell<span class="op">.</span>org<span class="op">/</span>ghc<span class="op">/</span>  <span class="op">:?</span> for help</span>
<span id="cb10-15"><a href="#cb10-15"></a><span class="dt">Loaded</span> <span class="dt">GHCi</span> configuration from <span class="op">/</span>home<span class="op">/</span>mgsloan<span class="op">/.</span>ghci</span>
<span id="cb10-16"><a href="#cb10-16"></a><span class="dt">Loaded</span> <span class="dt">GHCi</span> configuration from utils<span class="op">/</span>ghc<span class="op">-</span><span class="kw">in</span><span class="op">-</span>ghci<span class="op">/</span>inner<span class="op">.</span>ghci</span>
<span id="cb10-17"><a href="#cb10-17"></a><span class="dt">Prelude</span> [inner]<span class="op">&gt;</span> <span class="dv">1</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb10-18"><a href="#cb10-18"></a><span class="dv">2</span></span>
<span id="cb10-19"><a href="#cb10-19"></a><span class="dt">Prelude</span> [inner]<span class="op">&gt;</span> <span class="op">:</span>q</span>
<span id="cb10-20"><a href="#cb10-20"></a><span class="dt">Leaving</span> <span class="dt">GHCi</span><span class="op">.</span></span>
<span id="cb10-21"><a href="#cb10-21"></a><span class="dt">Main</span> [inner]<span class="op">&gt;</span> <span class="op">:</span>q</span>
<span id="cb10-22"><a href="#cb10-22"></a><span class="dt">Leaving</span> <span class="dt">GHCi</span><span class="op">.</span></span>
<span id="cb10-23"><a href="#cb10-23"></a><span class="dt">Main</span> [inner]<span class="op">&gt;</span> <span class="op">:</span>q</span>
<span id="cb10-24"><a href="#cb10-24"></a><span class="dt">Leaving</span> <span class="dt">GHCi</span><span class="op">.</span></span>
<span id="cb10-25"><a href="#cb10-25"></a>λ <span class="op">:</span>q</span>
<span id="cb10-26"><a href="#cb10-26"></a><span class="dt">Leaving</span> <span class="dt">GHCi</span><span class="op">.</span></span></code></pre></div><p>4 layers deep of <abbr>GHCi</abbr>! This is kinda cheating, though, because it is reusing the existing object files, and so it isn't really running the compiler.</p><p>I've tried removing the object files and loading <abbr>GHCi</abbr> inside <abbr>GHCi</abbr> inside <abbr>GHCi</abbr>, and it took about 9 minutes to load about 170 modules. At that point, it exited with a panic:</p><div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1"></a><span class="op">&lt;</span>no location info<span class="op">&gt;:</span> <span class="fu">error</span><span class="op">:</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>    ghc<span class="op">-</span>stage2<span class="op">:</span> panic<span class="op">!</span> (the 'impossible' happened)</span>
<span id="cb11-3"><a href="#cb11-3"></a>  (<span class="dt">GHC</span> version <span class="fl">8.7</span><span class="op">.</span><span class="dv">20180718</span> for x86_64<span class="op">-</span>unknown<span class="op">-</span>linux)<span class="op">:</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>        <span class="dt">ASSERT</span> failed<span class="op">!</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>  <span class="op">$</span>c<span class="op">==</span>_a81xD</span>
<span id="cb11-6"><a href="#cb11-6"></a>  <span class="dt">Call</span> stack<span class="op">:</span></span>
<span id="cb11-7"><a href="#cb11-7"></a>      <span class="dt">CallStack</span> (from <span class="dt">HasCallStack</span>)<span class="op">:</span></span>
<span id="cb11-8"><a href="#cb11-8"></a>        callStackDoc, called at compiler<span class="op">/</span>utils<span class="op">/</span>Outputable.hs<span class="op">:</span><span class="dv">1164</span><span class="op">:</span><span class="dv">37</span> <span class="kw">in</span> ghc<span class="op">:</span><span class="dt">Outputable</span></span>
<span id="cb11-9"><a href="#cb11-9"></a>        pprPanic, called at compiler<span class="op">/</span>utils<span class="op">/</span>Outputable.hs<span class="op">:</span><span class="dv">1223</span><span class="op">:</span><span class="dv">5</span> <span class="kw">in</span> ghc<span class="op">:</span><span class="dt">Outputable</span></span>
<span id="cb11-10"><a href="#cb11-10"></a>        assertPprPanic, called at compiler<span class="op">/</span>stgSyn<span class="op">/</span>CoreToStg.hs<span class="op">:</span><span class="dv">991</span><span class="op">:</span><span class="dv">78</span> <span class="kw">in</span> ghc<span class="op">:</span><span class="dt">CoreToStg</span></span></code></pre></div><p>This assertion wouldn't have been caught by an optimized build. It would be interesting to dig into what's going on there.</p><p>On to the question about how much slower this interpreted <abbr>GHC</abbr> is. The initial layering of having an interpreted <abbr>GHC</abbr> compile <abbr>GHC</abbr> definitely produces a massive slowdown in compilation speed. However, I each subsequent nesting would not compound the slowdown, because it's running object code. Even if the byte-code interpreter was being used, it's not being interpreted (it's written in C). Since the actual interpreter implementation is not being interpreted, the slowdown would not compound.</p><p>So pretty much, <abbr>GHCi</abbr> nesting does not follow inception's rules of time slow down :-)</p><h2 id="discussion--related-links"><a href="#discussion--related-links"></a>Discussion / Related Links</h2><ul><li><a href="https://www.reddit.com/r/haskell/comments/92szf7/ghc_inside_ghci">Discussion on r/haskell</a></li><li><a href="https://haskellweekly.news/issues/118.html">Mentioned in Haskell Weekly News!</a></li><li><a href="https://ghc.haskell.org/trac/ghc/wiki/Building/InGhci"><abbr>GHC</abbr> wiki page</a></li></ul></article><section id="teaser-section"><div id="teaser"><p class="smcp">More words</p><h2><a href="/posts/comfortable-airplane-computing">Computing comfortably at 30,000 feet</a></h2><p>How to use a laptop on an airline flight with decent ergonomics. <a href="/posts/comfortable-airplane-computing" class="smcp">Read</a></p></div></section><footer><div id="footer"><p id="notices" class="smcp"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Copyleft 2018-2020</a> <span id="breakdot">·</span> <a rel="author" href="https://mgsloan.com">Michael G Sloan</a> <span id="breakdot">·</span> <a href="https://github.com/mgsloan/mgsloan-site">Site Code</a> <span id="breakdot">·</span> <a href="/feed.xml">Feed</a></p><p id="profile-links" class="smcp"><a href="https://github.com/mgsloan">GitHub</a> <span id="breakdot">·</span> <a href="https://twitter.com/treetopian">Twitter</a></p></div></footer><dark-mode-toggle></dark-mode-toggle><script type="module" src="/dark-mode-toggle.mjs"></script><script>const toggle = document.querySelector('dark-mode-toggle'); const html = document.documentElement; toggle.addEventListener('colorschemechange', () => { html.classList.toggle('dark', toggle.mode === 'dark'); });</script></body></html>