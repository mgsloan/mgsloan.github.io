<!DOCTYPE html><html><head><meta charset="utf-8"><title>GHCinception: Running GHCi in GHCi</title><link href="/favicon.png" rel="icon" type="image/png"><link href="/feed.xml" rel="alternate" type="application/atom+xml"><link href="https://mgsloan.com/posts/ghcinception" rel="canonical"><meta name="description" content="My patches were merged, allowing GHC to be loaded into GHCi and run!"><meta name="author" content="Michael G Sloan"><meta name="viewport" content="width=device-width, initial-scale=1"><link href="https://fonts.googleapis.com/css?family=Alegreya:700|Alegreya+Sans:400,400i,700|Alegreya+Sans+SC|Inconsolata:400,700|Playfair+Display:400,700" rel="stylesheet"><style>*{margin:0;padding:0}code,em,strong{line-height:1}html{font-size:16px}body{background-color:#fffef8;padding-top:0.2em;color:#456;font-family:'Alegreya Sans',sans-serif;font-feature-settings:'liga','kern';line-height:1.6}#content,#teaser,#footer{padding:1.4em;margin-left:auto;margin-right:auto;max-width:36em}#content{padding-top:0;min-height:-moz-available;min-height:-webkit-fill-available;min-height:fill-available}header{font-family:'Playfair Display',sans;margin-left:1em;margin-right:1em;overflow:visible;text-align:center;margin-bottom:1.0em}h1{font-family:'Playfair Display',serif;color:#000;font-size:2.8em;line-height:3.8rem;margin-bottom:0.7rem;padding-top:2.8rem}header>h2{font-feature-settings:'dlig';font-size:1.4em;font-style:italic;font-weight:normal;line-height:1.4rem;margin-bottom:1.0rem;padding-top:0.4rem}header>p{padding-top:0.5em;padding-bottom:0.9em;margin-bottom:0}header>hr.hairline{margin-top:0.5em}hr.hairline{border:none;border-bottom:1px solid #c35;transform:scale(1.4,0.5)}h1>br{display:none}p,nav{margin-bottom:1em;padding-top:0.4em}a{color:#c35;text-decoration:none}abbr,.smcp{font-family:"Alegreya Sans SC";letter-spacing:0.1em}abbr{letter-spacing:0.03em;margin-right:-0.03em}.run-in{font-family:"Alegreya Sans SC";letter-spacing:0.05em}h2{font-family:Alegreya,serif;font-size:1.4em;line-height:1em;margin-bottom:0.2rem;padding-top:1.2rem}h2>a:before{content:'¶';width:1.2rem;margin-left:-1.2rem;display:inline-block;opacity:0;transition:opacity 0.2s ease-out;color:#b4aaaa}h2:hover>a:before{opacity:1}h2:target>a:before{opacity:1;color:#c35}ul,ol{counter-reset:ol;list-style:none;margin-bottom:1em;padding-top:0.4em}li{margin-left:1em;margin-bottom:1em}li:before{display:inline-block;margin-left:-1em;width:1em}ul>li:before{content:'•';font-weight:bold;transform:scale(2);position:relative;top:-0.15em}ol>li:before{content:counter(ol,decimal);counter-increment:ol;font-weight:bold}li>p:first-child{display:inline}li>ul{margin-left:1em}li>ul>li:before{content:"■";transform:scale(0.5)}table{border-spacing:0;margin-bottom:1em;margin-left:auto;margin-right:auto;text-align:left}th{padding-top:0.4em}th,td{padding-right:1.4em;vertical-align:top}code{font-family:Inconsolata,monospace;word-break:break-word;background-color:rgba(27,31,35,0.07)}pre>code{background-color:transparent}pre{border:1px solid #c35;color:#456;margin-bottom:0.6rem;margin-top:0.2rem;overflow-x:auto;padding:1rem;padding-left:1.4rem;margin-left:-1.4rem;margin-right:-1.4rem;font-size:0.9rem;line-height:1.4rem}pre:hover{overflow-x:auto}::-webkit-scrollbar{background-color:#fffef8}::-webkit-scrollbar-track{background-color:#fffef8}::-webkit-scrollbar-thumb{background-color:#c35}pre::-webkit-scrollbar-thumb{background-color:#fffef8}pre:hover::-webkit-scrollbar-thumb{background-color:#c35}.kw,.cf{color:#07a}.dt,.at{color:#d56}.fu{color:#690}.dv,.bn,.fl,.er{color:#905}.ch,.st{color:#d80}.co{color:#789}img{width:100%;height:auto;margin-top:-0.2em;margin-bottom:-0.6em}blockquote{font-family:Alegreya,serif;font-style:italic;padding-left:1em;padding-right:1em}#teaser-section{background-color:#c35;color:#f5b2c8}#teaser p:first-child{margin-bottom:0.3em}#teaser a{color:#fff;font-family:Alegreya,serif;line-height:0}#teaser a:after{color:#fff;content:'\a0»'}#teaser>h2{margin-bottom:0.2rem;padding-top:0.5rem}footer{background-color:#234;color:#b4aaaa}#notices{clear:both;text-align:center;padding-top:1.8em}footer span{margin-left:0.25em;margin-right:0.25em}@media(min-width:470px){html{font-size:16px}header{margin-left:2.8em;margin-right:2.8em}}@media(min-width:625px){html{font-size:17px}h1>br{display:block}h2>a:before{width:1.6rem;margin-left:-1.6rem}}@media(min-width:802px){html{font-size:18px}header{margin-top:1.4em}}@media(min-width:1003px){html{font-size:19px}}@media(min-width:1225px){#footer{max-width:42em}footer h2{margin-left:3rem}footer nav{float:left;text-align:right;width:6em;margin-left:-5em}#about{float:right;width:36em;margin-right:3em}}@media(min-width:400px){#content,#teaser,#footer{padding-left:2em;padding-right:2em}}@media(min-width:544px){#content,#teaser,#footer{padding-left:2.8em;padding-right:2.8em}li{margin-left:0}}@media(max-width:490px){#breakdot{display:block;height:0;overflow:hidden;width:0}}@media (-webkit-min-device-pixel-ratio:2),(min-device-pixel-ratio:2),(min-resolution:192dpi){pre{border-width:0.5px}}</style><script async src="https://www.googletagmanager.com/gtag/js?id=UA-126869629-1"></script><script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-126869629-1');</script></head><body><article id="content" itemscope><header><h1>GHCinception:<br> Running <abbr>GHCi</abbr> in <abbr>GHCi</abbr></h1><p><a href="/" class="author">mgsloan</a><br><time datetime="2018-07-28" itemprop="datePublished">28 July, 2018</time></p><hr class="hairline"></header><p>I'm happy to announce that you can now easily load <abbr>GHC</abbr> into <abbr>GHCi</abbr>! I've been using this for about a month now, and for me it makes <abbr>GHC</abbr> development far more pleasant than using <code>make</code>. This can often lead to iteration times of only <strong>10-30 seconds</strong> to try out some modified behavior.</p><p>For me, <abbr>GHCi</abbr> usage is crucial to efficient Haskell development. One larger project I work on takes a whopping 15 minutes to build, whereas loading the same code in <abbr>GHCi</abbr> takes a little bit less than 1 minute.</p><p><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/ghci.html"><abbr>GHCi</abbr></a> is quite a marvelous thing. Despite being an interpreter, it can run complicated programs quite quickly and correctly – I typically barely notice a difference in performance. One of the main reasons for this is that it still uses the compiled code for your dependencies. It also lets you conveniently query lots of information and try things out in a <a href="https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop"><abbr>REPL</abbr></a>.</p><h2 id="how-to-load-ghc-into-ghci"><a href="#how-to-load-ghc-into-ghci"></a>How to load <abbr>GHC</abbr> into <abbr>GHCi</abbr></h2><p>If you have a recent checkout of <abbr>GHC</abbr>, and have built the <abbr>GHC</abbr> stage 2 compiler located at <code>/inplace/bin/ghc-stage2</code>, then you can do the following to load <abbr>GHC</abbr> into <abbr>GHCi</abbr>:</p><pre><code>$ ./utils/ghc-in-ghci/run.sh -fobject-code -j8</code></pre><p>Tweak the <code>N</code> in <code>-jN</code> as is suitable for your system – it indicates the degree of module-level build parallelism. The number of logical cores you have is a reasonable guideline.</p><p>This should result in <abbr>GHCi</abbr> loading up the code for <abbr>GHC</abbr>:</p><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">mgsloan<span class="fu">@</span>treetop<span class="fu">:~/</span>oss<span class="fu">/</span>haskell<span class="fu">/</span>ghc<span class="fu">$</span> <span class="fu">./</span>utils<span class="fu">/</span>ghc<span class="fu">-</span><span class="kw">in</span><span class="fu">-</span>ghci<span class="fu">/</span>run<span class="fu">.</span>sh <span class="fu">-</span>fobject<span class="fu">-</span>code <span class="fu">-</span>j8
<span class="fu">+</span> export _GHC_TOP_DIR<span class="fu">=./</span>inplace<span class="fu">/</span>lib
<span class="fu">+</span> exec <span class="fu">./</span>inplace<span class="fu">/</span>bin<span class="fu">/</span>ghc<span class="fu">-</span>stage2 <span class="co">--interactive -ghci-script ./utils/ghc-in-ghci/settings.ghci -ghci-script ./utils/ghc-in-ghci/load-main.ghci -odir ./ghci-tmp -hidir ./ghci-tmp +RTS -A128m -RTS -fobject-code</span>
<span class="dt">GHCi</span>, version <span class="fl">8.7</span><span class="fu">.</span><span class="dv">20180718</span><span class="fu">:</span> http<span class="fu">://</span>www<span class="fu">.</span>haskell<span class="fu">.</span>org<span class="fu">/</span>ghc<span class="fu">/</span>  <span class="fu">:?</span> for help
<span class="dt">Loaded</span> <span class="dt">GHCi</span> configuration from <span class="fu">/</span>home<span class="fu">/</span>mgsloan<span class="fu">/.</span>ghci
package flags have changed, resetting and loading new packages<span class="fu">...</span>
<span class="dt">Loaded</span> <span class="dt">GHCi</span> configuration from <span class="fu">./</span>utils<span class="fu">/</span>ghc<span class="fu">-</span><span class="kw">in</span><span class="fu">-</span>ghci<span class="fu">/</span>settings<span class="fu">.</span>ghci
[  <span class="dv">1</span> <span class="kw">of</span> <span class="dv">493</span>] <span class="dt">Compiling</span> <span class="dt">GhcPrelude</span>       ( compiler<span class="fu">/</span>utils<span class="fu">/</span>GhcPrelude.hs, ghci<span class="fu">-</span>tmp<span class="fu">/</span>GhcPrelude.o )
[  <span class="dv">2</span> <span class="kw">of</span> <span class="dv">493</span>] <span class="dt">Compiling</span> <span class="dt">FiniteMap</span>        ( compiler<span class="fu">/</span>utils<span class="fu">/</span>FiniteMap.hs, ghci<span class="fu">-</span>tmp<span class="fu">/</span>FiniteMap.o )
[  <span class="dv">3</span> <span class="kw">of</span> <span class="dv">493</span>] <span class="dt">Compiling</span> <span class="dt">FastMutInt</span>       ( compiler<span class="fu">/</span>utils<span class="fu">/</span>FastMutInt.hs, ghci<span class="fu">-</span>tmp<span class="fu">/</span>FastMutInt.o )
[  <span class="dv">4</span> <span class="kw">of</span> <span class="dv">493</span>] <span class="dt">Compiling</span> <span class="dt">FastFunctions</span>    ( compiler<span class="fu">/</span>utils<span class="fu">/</span>FastFunctions.hs, ghci<span class="fu">-</span>tmp<span class="fu">/</span>FastFunctions.o )
[  <span class="dv">5</span> <span class="kw">of</span> <span class="dv">493</span>] <span class="dt">Compiling</span> <span class="dt">Exception</span>        ( compiler<span class="fu">/</span>utils<span class="fu">/</span>Exception.hs, ghci<span class="fu">-</span>tmp<span class="fu">/</span>Exception.o )
[  <span class="dv">6</span> <span class="kw">of</span> <span class="dv">493</span>] <span class="dt">Compiling</span> <span class="dt">EnumSet</span>          ( compiler<span class="fu">/</span>utils<span class="fu">/</span>EnumSet.hs, ghci<span class="fu">-</span>tmp<span class="fu">/</span>EnumSet.o )
[  <span class="dv">7</span> <span class="kw">of</span> <span class="dv">493</span>] <span class="dt">Compiling</span> <span class="dt">Encoding</span>         ( compiler<span class="fu">/</span>utils<span class="fu">/</span>Encoding.hs, ghci<span class="fu">-</span>tmp<span class="fu">/</span>Encoding.o )
<span class="fu">...</span></code></pre></div><p>This takes a while to load, since it's loading 493 modules. On my machine it clocks in at around 8 minutes. The main reason that this takes so long is that it needs to do object code generation. I bet it'd also load faster if I wasn't using an unoptimized <code>devel2</code> flavour build of <code>ghc-stage2</code>. This flavour includes potentially expensive assertions.</p><p>Once it has finished loading, you can use <abbr>GHCi</abbr> to ask for information as usual! For example, let's take a look at the datatype for a core expression:</p><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dt">Ok</span>, <span class="dv">493</span> modules loaded<span class="fu">.</span>
<span class="dt">Loaded</span> <span class="dt">GHCi</span> configuration from <span class="fu">./</span>utils<span class="fu">/</span>ghc<span class="fu">-</span><span class="kw">in</span><span class="fu">-</span>ghci<span class="fu">/</span>load<span class="fu">-</span>main<span class="fu">.</span>ghci
λ <span class="fu">:</span>m <span class="fu">+</span> <span class="dt">CoreSyn</span>
λ <span class="fu">:</span>info <span class="dt">Expr</span>
<span class="kw">data</span> <span class="dt">Expr</span> b
  <span class="fu">=</span> <span class="dt">Var</span> <span class="dt">Var.Id</span>
  <span class="fu">|</span> <span class="dt">Lit</span> <span class="dt">Literal.Literal</span>
  <span class="fu">|</span> <span class="dt">App</span> (<span class="dt">Expr</span> b) (<span class="dt">Arg</span> b)
  <span class="fu">|</span> <span class="dt">Lam</span> b (<span class="dt">Expr</span> b)
  <span class="fu">|</span> <span class="dt">Let</span> (<span class="dt">Bind</span> b) (<span class="dt">Expr</span> b)
  <span class="fu">|</span> <span class="dt">Case</span> (<span class="dt">Expr</span> b) b <span class="dt">TyCoRep.Type</span> [<span class="dt">Alt</span> b]
  <span class="fu">|</span> <span class="dt">Cast</span> (<span class="dt">Expr</span> b) <span class="dt">TyCoRep.Coercion</span>
  <span class="fu">|</span> <span class="dt">Tick</span> (<span class="dt">Tickish</span> <span class="dt">Var.Id</span>) (<span class="dt">Expr</span> b)
  <span class="fu">|</span> <span class="dt">Type</span> <span class="dt">TyCoRep.Type</span>
  <span class="fu">|</span> <span class="dt">Coercion</span> <span class="dt">TyCoRep.Coercion</span></code></pre></div><p>Beautiful! While <code>-fobject-code</code> does take quite a while to do an initial load, subsequent loads can be very fast. For me, with no code changes, it only takes about <strong>7 seconds</strong>.</p><h2 id="how-to-run-ghci-within-ghci"><a href="#how-to-run-ghci-within-ghci"></a>How to run <abbr>GHCi</abbr> within <abbr>GHCi</abbr></h2><p>The ghci script sets up some default arguments:</p><pre><code>:set args --interactive -ghci-script utils/ghc-in-ghci/inner.ghci</code></pre><p>Due to these defaults, just running <code>main</code> brings up a nested <abbr>GHCi</abbr>:</p><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">λ main
<span class="dt">GHCi</span>, version <span class="fl">8.7</span><span class="fu">.</span><span class="dv">20180718</span><span class="fu">:</span> http<span class="fu">://</span>www<span class="fu">.</span>haskell<span class="fu">.</span>org<span class="fu">/</span>ghc<span class="fu">/</span>  <span class="fu">:?</span> for help
<span class="dt">Loaded</span> <span class="dt">GHCi</span> configuration from <span class="fu">/</span>home<span class="fu">/</span>mgsloan<span class="fu">/.</span>ghci
<span class="dt">Loaded</span> <span class="dt">GHCi</span> configuration from utils<span class="fu">/</span>ghc<span class="fu">-</span><span class="kw">in</span><span class="fu">-</span>ghci<span class="fu">/</span>inner<span class="fu">.</span>ghci
<span class="dt">Prelude</span> [inner]<span class="fu">&gt;</span> <span class="fu">:</span>{
<span class="dt">Prelude</span><span class="fu">|</span> putStrLn <span class="fu">$</span> unwords <span class="fu">$</span>
<span class="dt">Prelude</span><span class="fu">|</span> <span class="st">"Wow, we're evaluating code"</span> <span class="fu">:</span> replicate <span class="dv">2</span> <span class="st">"*inside* GHCi"</span>
<span class="dt">Prelude</span><span class="fu">|</span> <span class="fu">:</span>}
<span class="dt">Wow</span>, we're evaluating code <span class="fu">*</span>inside<span class="fu">*</span> <span class="dt">GHCi</span> <span class="fu">*</span>inside<span class="fu">*</span> <span class="dt">GHCi</span>
<span class="dt">Prelude</span> [inner]<span class="fu">&gt;</span></code></pre></div><p>There's a different <abbr>GHCi</abbr> prompt there because the <code>inner.ghci</code> contains</p><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">:</span>set prompt <span class="st">"%s [inner]&gt; "</span></code></pre></div><p>When using this for development, I found that it was helpful to distinguish the inner ghci prompt from the outer.</p><h2 id="modifying-reloading-and-trying-some-new-behavior"><a href="#modifying-reloading-and-trying-some-new-behavior"></a>Modifying, reloading, and trying some new behavior</h2><p>Lets say I want to <a href="https://github.com/ghc-proposals/ghc-proposals/pull/156">change some type error messages</a>. First, I make a change to the code:</p><div class="sourceCode"><pre class="sourceCode diff"><code class="sourceCode diff"><span class="kw">diff --git a/compiler/typecheck/TcErrors.hs b/compiler/typecheck/TcErrors.hs</span>
index ecb404289a..32d7cffaab 100644
<span class="dt">--- a/compiler/typecheck/TcErrors.hs</span>
+++ b/compiler/typecheck/TcErrors.hs
@@ -1894,11 +1894,11 @@ misMatchMsg ct oriented ty1 ty2
   where
     herald1 = conc [ "Couldn't match"
                    , if is_repr     then "representation of" else ""
-                   , if is_oriented then "expected"          else ""
+                   , if is_oriented then "wanted"            else ""
                    , what ]
     herald2 = conc [ "with"
                    , if is_repr     then "that of"           else ""
-                   , if is_oriented then ("actual " ++ what) else "" ]
+                   , if is_oriented then ("found " ++ what)  else "" ]
     padding = length herald1 - length herald2

     is_repr = case ctEqRel ct of { ReprEq -&gt; True; NomEq -&gt; False }</code></pre></div><p>Then I do a reload, run the inner <abbr>GHCi</abbr>, and try it out:</p><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">λ <span class="fu">:</span>r
[ <span class="dv">22</span> <span class="kw">of</span> <span class="dv">493</span>] <span class="dt">Compiling</span> <span class="dt">Hooks</span>[boot]      ( compiler<span class="fu">/</span>main<span class="fu">/</span>Hooks.hs<span class="fu">-</span>boot, ghci<span class="fu">-</span>tmp<span class="fu">/</span>Hooks.o<span class="fu">-</span>boot )
<span class="fu">...</span> <span class="dt">Omitted</span> about <span class="dv">40</span> boot modules that load really quickly <span class="fu">...</span>
[<span class="dv">377</span> <span class="kw">of</span> <span class="dv">493</span>] <span class="dt">Compiling</span> <span class="dt">TcErrors</span>         ( compiler<span class="fu">/</span>typecheck<span class="fu">/</span>TcErrors.hs, ghci<span class="fu">-</span>tmp<span class="fu">/</span>TcErrors.o )
<span class="fu">...</span> <span class="dt">A</span> few more boot modules <span class="fu">...</span>
<span class="dt">Ok</span>, <span class="dv">493</span> modules loaded<span class="fu">.</span>
λ</code></pre></div><p>This only took about <strong>8 seconds</strong>!!! Invoking the inner <abbr>GHCi</abbr> takes <strong>less than a second</strong>:</p><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">λ main
<span class="dt">GHCi</span>, version <span class="fl">8.7</span><span class="fu">.</span><span class="dv">20180718</span><span class="fu">:</span> http<span class="fu">://</span>www<span class="fu">.</span>haskell<span class="fu">.</span>org<span class="fu">/</span>ghc<span class="fu">/</span>  <span class="fu">:?</span> for help
<span class="dt">Loaded</span> <span class="dt">GHCi</span> configuration from <span class="fu">/</span>home<span class="fu">/</span>mgsloan<span class="fu">/.</span>ghci
<span class="dt">Loaded</span> <span class="dt">GHCi</span> configuration from utils<span class="fu">/</span>ghc<span class="fu">-</span><span class="kw">in</span><span class="fu">-</span>ghci<span class="fu">/</span>inner<span class="fu">.</span>ghci
<span class="dt">Prelude</span> [inner]<span class="fu">&gt;</span> <span class="st">"testing"</span> <span class="fu">++</span> <span class="dt">Nothing</span>

<span class="fu">&lt;</span>interactive<span class="fu">&gt;:</span><span class="dv">1</span><span class="fu">:</span><span class="dv">14</span><span class="fu">:</span> error<span class="fu">:</span>
    • <span class="dt">Couldn't</span> match wanted <span class="kw">type</span> ‘[<span class="dt">Char</span>]’ with found <span class="kw">type</span> ‘<span class="dt">Maybe</span> a0’
    • <span class="dt">In</span> the second argument <span class="kw">of</span> ‘(<span class="fu">++</span>)’, namely ‘<span class="dt">Nothing</span>’
      <span class="dt">In</span> the expression<span class="fu">:</span> <span class="st">"testing"</span> <span class="fu">++</span> <span class="dt">Nothing</span>
      <span class="dt">In</span> an equation for ‘it’<span class="fu">:</span> it <span class="fu">=</span> <span class="st">"testing"</span> <span class="fu">++</span> <span class="dt">Nothing</span>
<span class="dt">Prelude</span> [inner]<span class="fu">&gt;</span></code></pre></div><p>For me, this is a game changer for <abbr>GHC</abbr> development. In particular, this means that you can make a change and very rapidly try out the change in behavior. On my machine, it often takes <strong>less than 10 seconds to make a change and try it out</strong>. This is drastically faster than <code>make</code> – I'm not even going to try, but I'm pretty sure I'd be waiting around for a few minutes.</p><h2 id="changes-made-to-ghc-for-this"><a href="#changes-made-to-ghc-for-this"></a>Changes made to <abbr>GHC</abbr> for this</h2><p>I opened a couple patches to <abbr>GHC</abbr> that got merged yesterday:</p><ul><li><p><a href="https://phabricator.haskell.org/D4904">D4904</a>, which adds a shell script and some ghci scripts for this. Most of of <code>settings.ghci</code> was written by Csongor Kiss – I found out about them via a <a href="https://mail.haskell.org/pipermail/ghc-devs/2018-May/015810.html">helpful mailing list post</a> from Matthew Pickering. I also incorporated some <abbr>RTS</abbr> arguments <a href="https://mail.haskell.org/pipermail/ghc-devs/2018-June/015844.html">suggested by Simon Marlow</a>. My main additions were making it so that <abbr>GHCi</abbr> could run inside of <abbr>GHCi</abbr>, and putting up a <abbr>GHC</abbr> differential.</p></li><li><p><a href="https://phabricator.haskell.org/D4986">D4986</a>, which makes some code changes to <abbr>GHC</abbr> that allow it all to be loaded into <abbr>GHCi</abbr> at once. These changes have no effect on the normal build.</p></li></ul><h2 id="why-is--fobject-code-needed"><a href="#why-is--fobject-code-needed"></a>Why is <code>-fobject-code</code> needed?</h2><p>After <a href="https://phabricator.haskell.org/D4904">D4904</a> was merged, I realized that <code>-fobject-code</code> should have been included in <code>settings.ghci</code>, and indeed it was in Csongor's version. Without it, you get errors like the following:</p><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">[ <span class="dv">16</span> <span class="kw">of</span> <span class="dv">493</span>] <span class="dt">Compiling</span> <span class="dt">State</span>            ( compiler<span class="fu">/</span>utils<span class="fu">/</span>State.hs, interpreted )
<span class="dt">Error</span><span class="fu">:</span> bytecode compiler can't handle unboxed tuples and sums<span class="fu">.</span>
  <span class="dt">Possibly</span> due to foreign import<span class="fu">/</span>export decls <span class="kw">in</span> source<span class="fu">.</span>
  <span class="dt">Workaround</span><span class="fu">:</span> use <span class="fu">-</span>fobject<span class="fu">-</span>code, or compile this <span class="kw">module</span> to <span class="fu">.</span>o separately<span class="fu">.</span></code></pre></div><p>I've opened another patch, <a href="https://phabricator.haskell.org/D5015">D5015</a> which adds this flag and improves how <code>-odir</code> and <code>-hidir</code> are specified. I'll update this post once that patch is merged.</p><p>It is unfortunate that <code>-fobject-code</code> is required, because it makes the load times take much longer than they would be otherwise. There are some benefits to it, though – the result executes faster, and subsequent <abbr>GHCi</abbr> loads will use the object files when possible.</p><h2 id="next-steps"><a href="#next-steps"></a>Next steps</h2><ul><li><p>I'm planning to do an optimized build of <code>ghc-stage2</code>, and use that instead. It may even make sense to have the ghci script use a different path if it exists, so that I can keep around an optimized <code>ghc-stage2</code>.</p></li><li><p>It would be really nice if <code>-fobject-code</code> wasn't needed to load code that uses <code>UnboxedTuples</code>. I have opened <a href="https://ghc.haskell.org/trac/ghc/ticket/15454">trac#15454</a> about adding some automagic to <abbr>GHCi</abbr> which would intelligently build just enough <code>-fobject-code</code> modules to handle the unboxed tuples, and use byte-code for everything else.</p></li><li><p>Are nightly builds of <abbr>GHC</abbr> downloadable from somewhere? If there are, then the following workflow could work for newcomers to <abbr>GHC</abbr> development:</p><ul><li><p>Download nightly build of <abbr>GHC</abbr></p></li><li><p>Load <abbr>GHC</abbr> into <abbr>GHCi</abbr> in ~10 minutes or less. I think that this would be <em>far</em> more appealing than the current recommended approach for newcomers, which is something like a 30 or 40 minute build process on my machine.</p></li></ul></li></ul><h2 id="can-we-go-three-layers-deep-does-time-slow-down"><a href="#can-we-go-three-layers-deep-does-time-slow-down"></a>Can we go three layers deep? Does time slow down?</h2><p><img src="/images/inception.jpg" alt="inception screenshot" width="1200" height="505"></p><p>A natural question is how deep can we go? Can <abbr>GHCi</abbr> run inside <abbr>GHCi</abbr> inside <abbr>GHCi</abbr>?! It turns out that it works directly, and the nesting works arbitrarily deep:</p><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dt">Prelude</span> [inner]<span class="fu">&gt;</span> <span class="fu">:</span>script utils<span class="fu">/</span>ghc<span class="fu">-</span><span class="kw">in</span><span class="fu">-</span>ghci<span class="fu">/</span>settings<span class="fu">.</span>ghci
package flags have changed, resetting and loading new packages<span class="fu">...</span>
<span class="dt">Prelude</span> [inner]<span class="fu">&gt;</span> <span class="fu">:</span>load <span class="dt">Main</span>
<span class="dt">Ok</span>, <span class="dv">493</span> modules loaded<span class="fu">.</span>
<span class="dt">Main</span> [inner]<span class="fu">&gt;</span> main
<span class="dt">GHCi</span>, version <span class="fl">8.7</span><span class="fu">.</span><span class="dv">20180718</span><span class="fu">:</span> http<span class="fu">://</span>www<span class="fu">.</span>haskell<span class="fu">.</span>org<span class="fu">/</span>ghc<span class="fu">/</span>  <span class="fu">:?</span> for help
<span class="dt">Loaded</span> <span class="dt">GHCi</span> configuration from <span class="fu">/</span>home<span class="fu">/</span>mgsloan<span class="fu">/.</span>ghci
<span class="dt">Loaded</span> <span class="dt">GHCi</span> configuration from utils<span class="fu">/</span>ghc<span class="fu">-</span><span class="kw">in</span><span class="fu">-</span>ghci<span class="fu">/</span>inner<span class="fu">.</span>ghci
<span class="dt">Prelude</span> [inner]<span class="fu">&gt;</span> <span class="fu">:</span>script utils<span class="fu">/</span>ghc<span class="fu">-</span><span class="kw">in</span><span class="fu">-</span>ghci<span class="fu">/</span>settings<span class="fu">.</span>ghci
package flags have changed, resetting and loading new packages<span class="fu">...</span>
<span class="dt">Prelude</span> [inner]<span class="fu">&gt;</span> <span class="fu">:</span>load <span class="dt">Main</span>
<span class="dt">Ok</span>, <span class="dv">493</span> modules loaded<span class="fu">.</span>
<span class="dt">Main</span> [inner]<span class="fu">&gt;</span> main
<span class="dt">GHCi</span>, version <span class="fl">8.7</span><span class="fu">.</span><span class="dv">20180718</span><span class="fu">:</span> http<span class="fu">://</span>www<span class="fu">.</span>haskell<span class="fu">.</span>org<span class="fu">/</span>ghc<span class="fu">/</span>  <span class="fu">:?</span> for help
<span class="dt">Loaded</span> <span class="dt">GHCi</span> configuration from <span class="fu">/</span>home<span class="fu">/</span>mgsloan<span class="fu">/.</span>ghci
<span class="dt">Loaded</span> <span class="dt">GHCi</span> configuration from utils<span class="fu">/</span>ghc<span class="fu">-</span><span class="kw">in</span><span class="fu">-</span>ghci<span class="fu">/</span>inner<span class="fu">.</span>ghci
<span class="dt">Prelude</span> [inner]<span class="fu">&gt;</span> <span class="dv">1</span> <span class="fu">+</span> <span class="dv">1</span>
<span class="dv">2</span>
<span class="dt">Prelude</span> [inner]<span class="fu">&gt;</span> <span class="fu">:</span>q
<span class="dt">Leaving</span> <span class="dt">GHCi</span><span class="fu">.</span>
<span class="dt">Main</span> [inner]<span class="fu">&gt;</span> <span class="fu">:</span>q
<span class="dt">Leaving</span> <span class="dt">GHCi</span><span class="fu">.</span>
<span class="dt">Main</span> [inner]<span class="fu">&gt;</span> <span class="fu">:</span>q
<span class="dt">Leaving</span> <span class="dt">GHCi</span><span class="fu">.</span>
λ <span class="fu">:</span>q
<span class="dt">Leaving</span> <span class="dt">GHCi</span><span class="fu">.</span></code></pre></div><p>4 layers deep of <abbr>GHCi</abbr>! This is kinda cheating, though, because it is reusing the existing object files, and so it isn't really running the compiler.</p><p>I've tried removing the object files and loading <abbr>GHCi</abbr> inside <abbr>GHCi</abbr> inside <abbr>GHCi</abbr>, and it took about 9 minutes to load about 170 modules. At that point, it exited with a panic:</p><div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="fu">&lt;</span>no location info<span class="fu">&gt;:</span> error<span class="fu">:</span>
    ghc<span class="fu">-</span>stage2<span class="fu">:</span> panic<span class="fu">!</span> (the <span class="ch">'impossible'</span> happened)
  (<span class="dt">GHC</span> version <span class="fl">8.7</span><span class="fu">.</span><span class="dv">20180718</span> for x86_64<span class="fu">-</span>unknown<span class="fu">-</span>linux)<span class="fu">:</span>
        <span class="dt">ASSERT</span> failed<span class="fu">!</span>
  <span class="fu">$</span>c<span class="fu">==</span>_a81xD
  <span class="dt">Call</span> stack<span class="fu">:</span>
      <span class="dt">CallStack</span> (from <span class="dt">HasCallStack</span>)<span class="fu">:</span>
        callStackDoc, called at compiler<span class="fu">/</span>utils<span class="fu">/</span>Outputable.hs<span class="fu">:</span><span class="dv">1164</span><span class="fu">:</span><span class="dv">37</span> <span class="kw">in</span> ghc<span class="fu">:</span><span class="dt">Outputable</span>
        pprPanic, called at compiler<span class="fu">/</span>utils<span class="fu">/</span>Outputable.hs<span class="fu">:</span><span class="dv">1223</span><span class="fu">:</span><span class="dv">5</span> <span class="kw">in</span> ghc<span class="fu">:</span><span class="dt">Outputable</span>
        assertPprPanic, called at compiler<span class="fu">/</span>stgSyn<span class="fu">/</span>CoreToStg.hs<span class="fu">:</span><span class="dv">991</span><span class="fu">:</span><span class="dv">78</span> <span class="kw">in</span> ghc<span class="fu">:</span><span class="dt">CoreToStg</span></code></pre></div><p>This assertion wouldn't have been caught by an optimized build. It would be interesting to dig into what's going on there.</p><p>On to the question about how much slower this interpreted <abbr>GHC</abbr> is. The initial layering of having an interpreted <abbr>GHC</abbr> compile <abbr>GHC</abbr> definitely produces a massive slowdown in compilation speed. However, I each subsequent nesting would not compound the slowdown, because it's running object code. Even if the byte-code interpreter was being used, it's not being interpreted (it's written in C). Since the actual interpreter implementation is not being interpreted, the slowdown would not compound.</p><p>So pretty much, <abbr>GHCi</abbr> nesting does not follow inception's rules of time slow down :-)</p></article><section id="teaser-section"><div id="teaser"><p class="smcp">More words</p><h2>Computing comfortably at 30,000 feet</h2><p>How to use a laptop on an airline flight with decent ergonomics. <a href="/posts/comfortable-airplane-computing" class="smcp">Read full post</a></p></div></section><footer><div id="footer"><p id="notices" class="smcp"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Copyleft 2018</a> <span id="breakdot">·</span> Michael G Sloan <span id="breakdot">·</span> <a href="https://github.com/mgsloan/mgsloan-site">Source</a></p></div></footer></body></html>